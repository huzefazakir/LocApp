<?php include("get_distance.php"); ?>

<?php
    
    $conHandle = mysql_connect('127.0.0.1', 'root', 'location');

    if (!$conHandle) {
	die('Could not connect: ' . mysql_error());
    }

    $db_selected = mysql_select_db('user_db');

    if (!$db_selected) {
        die('Cannot use location: ' . mysql_error());
    }
  
    mysql_query("UPDATE user_location_table SET logitude =" .$_REQUEST['longitude'].", latitude =" .$_REQUEST['latitude']. "where user_id ='" .$_REQUEST['user_id']."'");
    


    $myDist = new DistanceCalculator($_REQUEST['longitude'], $_REQUEST['latitude']);
 
    $result = mysql_query("SELECT * FROM user_location_table");
  
    if (!$result) {
        die('invalid query: ' . mysql_error());
    }
    
    if (mysql_num_rows($result) == 0) {
        echo "No rows found in user_location_table, exiting";
        mysql_close();
        exit;
    }
    
    #echo mysql_error();

    while ($row = mysql_fetch_assoc($result)) {
       $distance =  $myDist->calculateDistance($row['latitude'], $row['logitude']);
       $result_update_user_loc = mysql_query("UPDATE location SET distance =" .$distance. ", time_stamp ='" .$row['cur_timestamp']. "' where user_id='" .$row['user_id']. "'");
       
       if (!$result_update_user_loc){
           #echo "unable to update location table";
       }
    }

    $result_locations = mysql_query("SELECT * FROM location");

    if (!$result_locations) {
	die('invalid query: ' . mysql_error());
    }

    if (mysql_num_rows($result_locations) == 0) {
    	echo "No rows found, exiting";
        mysql_close();
    	exit;
    }
    
    $jLocations = array();
    while ($rows = mysql_fetch_assoc($result_locations)) {
    	$jLocations[]=$rows;
    }

    print(json_encode($jLocations));
    mysql_close();
?>
